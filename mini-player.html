<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chris Chattom — Mini Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Inter font (optional, matches your main site) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --panel-edge: #111827;
      --accent: #22d3ee;
      --text: #e5e7eb;
      --soft: rgba(15,23,42,0.9);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .frame {
      width: 380px;
      max-width: 100%;
      padding: 10px;
      background: radial-gradient(circle at 50% 0%, #0f172a, #000);
    }

    .mini-shell {
      border-radius: 18px;
      background:
        radial-gradient(circle at 50% 0%, rgba(148,163,184,0.12), transparent 60%),
        linear-gradient(to bottom, #020617, #020617 55%, #020617);
      border: 1px solid #1e293b;
      box-shadow:
        0 18px 40px rgba(0,0,0,0.9),
        inset 0 0 26px rgba(15,23,42,1);
      padding: 14px 16px 16px;
    }

    .mini-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .mini-title {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #64748b;
    }

    .mini-track {
      font-size: 13px;
      font-weight: 500;
      text-align: right;
      color: #e5e7eb;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* VU meters row */
    .vu-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .vu-meter {
      position: relative;
      width: 150px;
      height: 68px;
      border-radius: 10px;
      padding: 6px 8px 8px;
      background:
        radial-gradient(circle at 50% -50%, rgba(15,23,42,0.9), transparent 70%),
        linear-gradient(to bottom, #020617, #020617);
      box-shadow:
        0 6px 16px rgba(0,0,0,0.9),
        inset 0 0 12px rgba(15,23,42,1);
      overflow: hidden;
    }

    .vu-inner {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 6px;
      background: #111827;
      border: 1px solid #020617;
      box-shadow:
        inset 0 0 4px rgba(0,0,0,0.8),
        inset 0 0 24px rgba(15,23,42,1);
      overflow: hidden;
    }

    /* scale arc / ticks */
    .vu-scale {
      position: absolute;
      left: 10px;
      right: 10px;
      top: 8px;
      height: 32px;
    }

    .vu-tick {
      position: absolute;
      bottom: 0;
      width: 1px;
      background: #cbd5f5;
      opacity: 0.75;
    }

    .vu-tick.label span {
      position: absolute;
      top: -10px;
      left: -6px;
      font-size: 8px;
      color: #cbd5f5;
    }

    .vu-red-zone {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 32px;
      height: 16px;
      background: linear-gradient(to right, #f97316, #ef4444);
      clip-path: polygon(0 100%, 100% 100%, 100% 40%, 0 0);
      opacity: 0.9;
    }

    .vu-label {
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .vu-peak-dot {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fecaca, #b91c1c);
      box-shadow: 0 0 3px #f87171;
      opacity: 0.1;
      transition: opacity 80ms ease-out;
    }

    /* backlight that glows with signal */
    .vu-backlight {
      position: absolute;
      inset: 0;
      border-radius: 6px;
      background: radial-gradient(circle at 50% 80%, rgba(34,211,238,0.2), transparent 70%);
      mix-blend-mode: screen;
      opacity: 0;
      transition: opacity 80ms ease-out;
      pointer-events: none;
    }

    /* needle */
    .vu-needle {
      position: absolute;
      bottom: 10px;
      left: 50%;
      width: 70px;
      height: 70px;
      transform-origin: 50% 80%;
      transform: translateX(-50%) rotate(-25deg);
      pointer-events: none;
    }

    .vu-needle-line {
      position: absolute;
      bottom: 14px;
      left: 50%;
      width: 1.5px;
      height: 40px;
      transform: translateX(-50%);
      background: linear-gradient(to top, #e5e7eb, #cbd5f5);
      box-shadow: 0 0 2px #e5e7eb;
    }

    .vu-needle-hub {
      position: absolute;
      bottom: 10px;
      left: 50%;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      transform: translateX(-50%);
      background: radial-gradient(circle at 30% 20%, #f9fafb, #4b5563);
      box-shadow:
        0 0 3px rgba(0,0,0,0.8),
        inset 0 0 2px rgba(0,0,0,0.9);
    }

    /* time + progress */
    .time-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0 8px;
      font-size: 10px;
      color: #9ca3af;
    }

    .time-row span {
      min-width: 32px;
      text-align: center;
    }

    .progress-rail {
      position: relative;
      flex: 1;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 150%, rgba(15,23,42,0.9), #020617);
      box-shadow:
        inset 0 0 6px rgba(15,23,42,0.9),
        0 0 10px rgba(15,23,42,0.7);
      cursor: pointer;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(to right,#f9fafb,#e5e7eb,#f9fafb);
      box-shadow: 0 0 12px rgba(248,250,252,0.9);
      width: 0%;
    }

    /* transport + volume */
    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 4px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
    }

    .mini-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,0.3), transparent 55%),
        radial-gradient(circle at 70% 80%, #020617, #020617);
      box-shadow:
        0 6px 12px rgba(0,0,0,0.9),
        inset 0 2px 4px rgba(255,255,255,0.32);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
      transition: transform 100ms ease, box-shadow 100ms ease, filter 120ms ease;
      filter: drop-shadow(0 0 2px rgba(34,211,238,0.15));
    }

    .mini-btn:hover {
      transform: translateY(-1px);
      filter: drop-shadow(0 0 8px rgba(34,211,238,0.6));
    }

    .mini-btn:active {
      transform: translateY(1px) scale(0.96);
      box-shadow:
        0 3px 8px rgba(0,0,0,0.9),
        inset 0 1px 3px rgba(0,0,0,0.8);
    }

    .mini-btn.playing {
      box-shadow:
        0 0 0 2px rgba(34,211,238,0.3),
        0 0 12px rgba(34,211,238,0.7),
        inset 0 2px 4px rgba(255,255,255,0.32);
    }

    .vol-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      flex: 1;
      justify-content: flex-end;
    }

    .vol-slider {
      width: 90px;
    }

    .vol-slider input[type="range"] {
      width: 100%;
      appearance: none;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(to right,
        rgba(148,163,184,0.85),
        rgba(71,85,105,0.9));
      outline: none;
      cursor: pointer;
    }

    .vol-slider input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background:#f9fafb;
      border: 1px solid rgba(148,163,184,0.9);
      box-shadow:
        0 0 6px rgba(34,211,238,0.5),
        0 2px 4px rgba(0,0,0,0.7);
      margin-top: -4px;
    }

    .vol-slider input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background:#f9fafb;
      border: 1px solid rgba(148,163,184,0.9);
      box-shadow:
        0 0 6px rgba(34,211,238,0.5),
        0 2px 4px rgba(0,0,0,0.7);
    }

    .vol-pct {
      font-size: 10px;
      color:#9ca3af;
      min-width: 30px;
      text-align: right;
    }

    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="frame">
    <div class="mini-shell">
      <div class="mini-header">
        <div class="mini-title">Mini Player</div>
        <div id="trackTitle" class="mini-track">Loading…</div>
      </div>

      <div class="vu-row">
        <div class="vu-meter">
          <div class="vu-inner">
            <div class="vu-backlight" id="vuBackL"></div>
            <div class="vu-scale">
              <!-- simple ticks -->
              <div class="vu-tick" style="left:4%; height:10px;"></div>
              <div class="vu-tick label" style="left:16%; height:14px;">
                <span>-10</span>
              </div>
              <div class="vu-tick" style="left:28%; height:12px;"></div>
              <div class="vu-tick label" style="left:40%; height:14px;">
                <span>-3</span>
              </div>
              <div class="vu-tick label" style="left:56%; height:16px;">
                <span>0</span>
              </div>
              <div class="vu-tick" style="left:68%; height:14px;"></div>
              <div class="vu-tick" style="left:80%; height:14px;"></div>
              <div class="vu-red-zone"></div>
            </div>
            <div class="vu-needle" id="vuNeedleL">
              <div class="vu-needle-line"></div>
              <div class="vu-needle-hub"></div>
            </div>
            <div class="vu-label">L</div>
            <div class="vu-peak-dot" id="vuPeakL"></div>
          </div>
        </div>

        <div class="vu-meter">
          <div class="vu-inner">
            <div class="vu-backlight" id="vuBackR"></div>
            <div class="vu-scale">
              <div class="vu-tick" style="left:4%; height:10px;"></div>
              <div class="vu-tick label" style="left:16%; height:14px;">
                <span>-10</span>
              </div>
              <div class="vu-tick" style="left:28%; height:12px;"></div>
              <div class="vu-tick label" style="left:40%; height:14px;">
                <span>-3</span>
              </div>
              <div class="vu-tick label" style="left:56%; height:16px;">
                <span>0</span>
              </div>
              <div class="vu-tick" style="left:68%; height:14px;"></div>
              <div class="vu-tick" style="left:80%; height:14px;"></div>
              <div class="vu-red-zone"></div>
            </div>
            <div class="vu-needle" id="vuNeedleR">
              <div class="vu-needle-line"></div>
              <div class="vu-needle-hub"></div>
            </div>
            <div class="vu-label">R</div>
            <div class="vu-peak-dot" id="vuPeakR"></div>
          </div>
        </div>
      </div>

      <div class="time-row">
        <span id="timeCurrent">0:00</span>
        <div class="progress-rail" id="seekRail">
          <div class="progress-fill" id="seekFill"></div>
        </div>
        <span id="timeTotal">0:00</span>
      </div>

      <div class="controls-row">
        <div class="btn-row">
          <button class="mini-btn" id="btnPrev" title="Previous track">⏮</button>
          <button class="mini-btn" id="btnPlay" title="Play / Pause">▶</button>
          <button class="mini-btn" id="btnNext" title="Next track">⏭</button>
        </div>
        <div class="vol-wrap">
          <div class="vol-slider">
            <input id="volSlider" type="range" min="0" max="1" step="0.01" value="0.9">
          </div>
          <span class="vol-pct" id="volPct">90%</span>
        </div>
      </div>
    </div>

    <audio id="miniAudio" class="hidden">
      Your browser does not support the audio element.
    </audio>
  </div>

  <script>
    // ------------- Track list (matches music.html) -------------
    const TRACKS = [
      { id: '01', name: 'The Copycat',             file: 'The_Copycat.mp3' },
      { id: '02', name: 'Moving Forward',          file: 'Moving_Forward.mp3' },
      { id: '03', name: 'Fleetwood National',      file: 'Fleetwood_National.mp3' },
      { id: '04', name: 'Ashes and Aurora',        file: 'Ashes_and_Aurora.mp3' },
      { id: '05', name: 'Sugartrain Voyage',       file: 'Sugartrain_Voyage.mp3' },
      { id: '06', name: 'Car Crash in Cardiff',    file: 'Car_Crash_in_Cardiff.mp3' },
      { id: '07', name: 'Dune Audio',              file: 'Dune_Audio.mp3' },
      { id: '08', name: 'Slow Roast',              file: 'Slow_Roast.mp3' },
      { id: '09', name: 'Bayou Moon',              file: 'Bayou_Moon.mp3' },
      { id: '10', name: 'Lonely Carbon Lifeforms', file: 'Lonely_Carbon_Lifeforms.mp3' },
      { id: '11', name: 'The Magical Third',       file: 'The_Magical_Third.mp3' },
      { id: '12', name: 'Up and Down',             file: 'Up_and_Down.mp3' },
      { id: '13', name: 'Arcadia Drive',           file: 'Arcadia_Drive.mp3' },
      { id: '14', name: 'Ocean Post',              file: 'Ocean_Post.mp3' },
      { id: '15', name: 'Covert Company',          file: 'Covert_Company.mp3' },
      { id: '16', name: 'Too Many Lights',         file: 'Too_Many_Lights.mp3' },
      { id: '17', name: 'American Sword',          file: 'American_Sword.mp3' },
      { id: '18', name: 'Go Driving Fast',         file: 'Go_Driving_Fast.mp3' },
    ];

    const AUDIO_BASE = "assets/";

    const audioEl     = document.getElementById('miniAudio');
    const titleEl     = document.getElementById('trackTitle');
    const btnPrev     = document.getElementById('btnPrev');
    const btnPlay     = document.getElementById('btnPlay');
    const btnNext     = document.getElementById('btnNext');
    const volSlider   = document.getElementById('volSlider');
    const volPct      = document.getElementById('volPct');

    const timeCurEl   = document.getElementById('timeCurrent');
    const timeTotEl   = document.getElementById('timeTotal');
    const seekRail    = document.getElementById('seekRail');
    const seekFill    = document.getElementById('seekFill');

    const needleL     = document.getElementById('vuNeedleL');
    const needleR     = document.getElementById('vuNeedleR');
    const backL       = document.getElementById('vuBackL');
    const backR       = document.getElementById('vuBackR');
    const peakL       = document.getElementById('vuPeakL');
    const peakR       = document.getElementById('vuPeakR');

    let currentIndex  = 0;
    let isPlaying     = false;

    // Try to pick up state from opener (music.html)
    try {
      const cfg = window.opener && window.opener.miniplayerConfig;
      if (cfg) {
        if (typeof cfg.trackIndex === 'number') currentIndex = cfg.trackIndex;
        if (typeof cfg.volume === 'number') {
          volSlider.value = cfg.volume;
        }
      }
    } catch (e) {
      // cross-origin guard, ignore
    }

    // ---------- Web Audio: gain + analyser ----------
    let audioCtx = null;
    let gainNode = null;
    let analyser = null;
    let dataArray = null;
    let rafId = null;
    let vuHold = 0; // peak hold value

    function initAudioGraph() {
      if (audioCtx) return;
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;

      audioCtx = new AudioCtx();
      const source = audioCtx.createMediaElementSource(audioEl);
      gainNode = audioCtx.createGain();
      analyser = audioCtx.createAnalyser();

      analyser.fftSize = 512;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      source.connect(gainNode);
      gainNode.connect(analyser);
      analyser.connect(audioCtx.destination);

      updateGainFromSlider();
      startMeterLoop();
    }

    function startMeterLoop() {
      if (!analyser) return;
      if (rafId) cancelAnimationFrame(rafId);

      const minDeg = -23; // left stop
      const maxDeg = 25;  // red
      let smooth = 0;

      const tick = () => {
        analyser.getByteTimeDomainData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          const v = (dataArray[i] - 128) / 128;
          sum += v * v;
        }
        const rms = Math.sqrt(sum / dataArray.length);
        const level = Math.min(1, rms * 5.5); // scale a bit hotter

        // exponential smoothing for nice analog feel
        const smoothing = 0.25;
        smooth = smooth + (level - smooth) * smoothing;

        // convert to degrees
        const deg = minDeg + (maxDeg - minDeg) * smooth;

        needleL.style.transform = `translateX(-50%) rotate(${deg}deg)`;
        needleR.style.transform = `translateX(-50%) rotate(${deg}deg)`;

        // backlight glow
        const glow = Math.min(1, level * 1.5);
        backL.style.opacity = glow;
        backR.style.opacity = glow;

        // simple peak indicator
        vuHold = Math.max(vuHold * 0.92, level);
        const peakOpacity = vuHold > 0.8 ? 0.9 : vuHold > 0.6 ? 0.5 : 0.12;
        peakL.style.opacity = peakOpacity;
        peakR.style.opacity = peakOpacity;

        rafId = requestAnimationFrame(tick);
      };

      tick();
    }

    function formatTime(sec) {
      if (!isFinite(sec) || sec < 0) return '0:00';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return m + ':' + (s < 10 ? '0' + s : s);
    }

    function loadTrack(index, startTime) {
      const track = TRACKS[index];
      if (!track) return;

      currentIndex = index;
      titleEl.textContent = track.name;

      audioEl.src = AUDIO_BASE + track.file;
      audioEl.load();
      if (startTime && startTime > 0) {
        audioEl.currentTime = startTime;
      }

      audioEl.volume = parseFloat(volSlider.value);
    }

    function updateGainFromSlider() {
      const vol = parseFloat(volSlider.value);
      audioEl.volume = vol;
      if (gainNode) gainNode.gain.value = vol;
      volPct.textContent = Math.round(vol * 100) + '%';
    }

    // ---------- Event wiring ----------
    btnPrev.addEventListener('click', () => {
      const nextIndex = (currentIndex - 1 + TRACKS.length) % TRACKS.length;
      loadTrack(nextIndex, 0);
      playAudio();
    });

    btnNext.addEventListener('click', () => {
      const nextIndex = (currentIndex + 1) % TRACKS.length;
      loadTrack(nextIndex, 0);
      playAudio();
    });

    btnPlay.addEventListener('click', () => {
      if (isPlaying) {
        audioEl.pause();
        isPlaying = false;
        btnPlay.textContent = '▶';
        btnPlay.classList.remove('playing');
      } else {
        playAudio();
      }
    });

    function playAudio() {
      initAudioGraph();
      audioEl.play()
        .then(() => {
          isPlaying = true;
          if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume().catch(() => {});
          }
          btnPlay.textContent = '⏸';
          btnPlay.classList.add('playing');
        })
        .catch(() => {});
    }

    audioEl.addEventListener('timeupdate', () => {
      timeCurEl.textContent = formatTime(audioEl.currentTime || 0);
      timeTotEl.textContent = formatTime(audioEl.duration || 0);
      if (audioEl.duration) {
        const pct = (audioEl.currentTime / audioEl.duration) * 100;
        seekFill.style.width = pct + '%';
      } else {
        seekFill.style.width = '0%';
      }
    });

    audioEl.addEventListener('loadedmetadata', () => {
      timeTotEl.textContent = formatTime(audioEl.duration || 0);
    });

    audioEl.addEventListener('ended', () => {
      // auto-advance like big player
      const nextIndex = (currentIndex + 1) % TRACKS.length;
      loadTrack(nextIndex, 0);
      playAudio();
    });

    seekRail.addEventListener('click', (e) => {
      if (!audioEl.duration) return;
      const rect = seekRail.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      const clamped = Math.max(0, Math.min(1, ratio));
      audioEl.currentTime = clamped * audioEl.duration;
    });

    volSlider.addEventListener('input', updateGainFromSlider);

    // ---------- Initial load ----------
    // If opener gave us a start time, use it once metadata is ready.
    let openerStartTime = 0;
    try {
      const cfg = window.opener && window.opener.miniplayerConfig;
      if (cfg && typeof cfg.currentTime === 'number') openerStartTime = cfg.currentTime;
    } catch (e) {}

    loadTrack(currentIndex, openerStartTime);

    // Autoplay if main player was playing
    try {
      const cfg = window.opener && window.opener.miniplayerConfig;
      if (cfg && cfg.isPlaying) {
        playAudio();
      }
    } catch (e) {}
  </script>
</body>
</html>
