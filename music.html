<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chris Chattom ‚Äî Music</title>
  <meta name="description" content="Original audio works by Chris Chattom." />

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --accent:#00f5d4;
      --glow-soft: rgba(34, 211, 238, 0.12);
      --glow-strong: rgba(34, 211, 238, 0.55);
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:#000;
      color:#f8fafc;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    /* NAVBAR */
    .site-nav {
      display:flex;
      justify-content:center;
      gap:2.2rem;
      margin-top:2rem;
      font-weight:500;
    }
    .site-nav a {
      color:#f8fafc;
      text-decoration:none;
      position:relative;
      padding-bottom:4px;
      transition:color .3s ease;
    }
    .site-nav a::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:0;
      width:0%;
      height:2px;
      background-color:var(--accent);
      border-radius:2px;
      transition:all .35s cubic-bezier(0.4,0,0.2,1);
      transform:translateX(-50%);
    }
    .site-nav a:hover::after{ width:100%; }
    .site-nav [aria-current="page"]{
      color:var(--accent);
    }
    .site-nav [aria-current="page"]::after{
      width:100%;
    }
    @media (max-width:640px){
      .site-nav{
        gap:1.2rem;
        margin-top:1rem;
        font-size:15px;
        flex-wrap:wrap;
      }
      .site-nav a{
        padding-bottom:6px;
        -webkit-tap-highlight-color:rgba(0,0,0,0);
      }
    }

    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:32px 20px 48px;
    }
    .music-header {
      text-align:center;
      margin-bottom:1.5rem;
    }
    .music-header h1{
      font-size:clamp(24px,3vw,32px);
      margin:0 0 8px;
    }
    .music-header p{
      margin:0;
      color:#94a3b8;
      font-size:0.95rem;
    }

    #root{ margin-top:24px; }

    /* --- Retro tube deck --- */
    .tube-window{
      border-radius:1.6rem;
      border:1px solid rgba(148,163,184,0.6);
      background:
        radial-gradient(circle at 50% 0%, rgba(255,255,255,0.06), transparent 55%),
        linear-gradient(to bottom,#020617,#020617,#020617,#020617,#020617);
      box-shadow:
        inset 0 0 40px rgba(15,23,42,1),
        0 24px 60px rgba(0,0,0,0.85);
      padding:1.7rem 1.9rem;
      display:flex;
      justify-content:space-between;
    }

    /* metal shell the glass sits in */
    .tube-shell{
      width:58px;
      height:150px;
      border-radius:999px;
      background:linear-gradient(
        to bottom,
        #020617 0%,
        #111827 35%,
        #020617 100%
      );
      box-shadow:
        0 18px 30px rgba(0,0,0,0.85),
        inset 0 1px 3px rgba(255,255,255,0.16);
      padding:10px 11px 14px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }

    /* glass envelope */
    .tube-glass{
      position:relative;
      width:32px;
      height:120px;
      border-radius:999px;
      background:
        radial-gradient(circle at 22% 12%, rgba(255,255,255,0.55), transparent 55%),
        radial-gradient(circle at 75% 25%, rgba(255,255,255,0.24), transparent 55%),
        linear-gradient(
          to bottom,
          rgba(248,250,252,0.65) 0%,
          rgba(148,163,184,0.25) 40%,
          rgba(15,23,42,0.85) 100%
        );
      overflow:hidden;
    }

    /* inner metal structure */
    .tube-electrodes{
      position:absolute;
      inset:18px 9px 28px;
      border-radius:10px;
      background:
        linear-gradient(to right,rgba(15,23,42,0.9),rgba(30,41,59,0.9));
      box-shadow:
        inset 0 0 6px rgba(0,0,0,0.9),
        0 0 4px rgba(15,23,42,0.8);
      opacity:0.9;
    }

    /* glowing gas column reacting to level */
    .tube-core{
      position:absolute;
      left:6px;
      right:6px;
      bottom:10px;
      transform-origin:bottom center;
      border-radius:999px;
      background:
        radial-gradient(circle at 50% 120%, rgba(251,146,60,0.95), rgba(248,250,252,0.15)),
        linear-gradient(to top, rgba(251,146,60,0.85), rgba(56,189,248,0.25));
      box-shadow:0 0 14px rgba(251,146,60,0.9);
      transition: transform 140ms ease-out,
                  box-shadow 140ms ease-out,
                  opacity 140ms ease-out;
    }

    /* filament at base */
    .tube-filament{
      position:absolute;
      left:50%;
      bottom:5px;
      width:26px;
      height:10px;
      border-radius:999px;
      transform:translateX(-50%);
      background:radial-gradient(circle at 50% 50%, rgba(251,146,60,0.95), transparent 60%);
      filter:blur(1px);
    }

    /* socket assembly under each tube */
    .tube-socket{
      margin-top:0.45rem;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    /* top ring (horizontal pill) ‚Äì Illustrator gradient */
    .tube-socket-top{
      position:relative;
      width:60px;
      height:16px;
      border-radius:999px;
      background:linear-gradient(to right,#3b3f48,#151b24);
      box-shadow:
        0 3px 8px rgba(0,0,0,0.9),
        inset 0 1px 2px rgba(255,255,255,0.22),
        inset 0 -1px 3px rgba(15,23,42,0.9);
      overflow:hidden;
    }

    /* vertical post under the ring */
    .tube-socket-post{
      position:relative;
      margin-top:3px;
      width:26px;
      height:26px;
      border-radius:8px 8px 4px 4px; /* top more rounded, bottom just a little */
      background:linear-gradient(to bottom,#373c46,#151b24);
      box-shadow:
        0 4px 10px rgba(0,0,0,0.85),
        inset 0 1px 2px rgba(255,255,255,0.12),
        inset 0 -2px 3px rgba(15,23,42,0.95);
      overflow:hidden;
    }

    /* shared highlight sweep ‚Äì runs across ring + post in unison */
    .tube-socket-top::before,
    .tube-socket-post::before{
      content:"";
      position:absolute;
      top:-40%;
      left:-60%;
      width:70%;
      height:200%;
      border-radius:50%;
      background:radial-gradient(
        circle at 0 50%,
        rgba(209,213,219,0.9),
        transparent 60%
      );
      opacity:0;
      animation:tubeBaseSweep 5.5s linear infinite;
    }

    @keyframes tubeBaseSweep{
      0%{
        transform:translateX(0%);
        opacity:0;
      }
      12%{
        opacity:0.9;
      }
      45%{
        opacity:0.65;
      }
      70%{
        opacity:0.0;
      }
      100%{
        transform:translateX(260%);
        opacity:0;
      }
    }

    /* stagger for each tube base */
    .tube-window > div:nth-child(1) .tube-socket-top::before,
    .tube-window > div:nth-child(1) .tube-socket-post::before{ animation-delay:0s; }
    .tube-window > div:nth-child(2) .tube-socket-top::before,
    .tube-window > div:nth-child(2) .tube-socket-post::before{ animation-delay:0.4s; }
    .tube-window > div:nth-child(3) .tube-socket-top::before,
    .tube-window > div:nth-child(3) .tube-socket-post::before{ animation-delay:0.8s; }
    .tube-window > div:nth-child(4) .tube-socket-top::before,
    .tube-window > div:nth-child(4) .tube-socket-post::before{ animation-delay:1.2s; }
    .tube-window > div:nth-child(5) .tube-socket-top::before,
    .tube-window > div:nth-child(5) .tube-socket-post::before{ animation-delay:1.6s; }

    /* --- Progress strip --- */
    .progress-rail{
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background:radial-gradient(circle at 50% 150%, rgba(15,23,42,0.9), #020617);
      box-shadow:
        inset 0 0 6px rgba(15,23,42,0.9),
        0 0 16px rgba(15,23,42,0.7);
      cursor:pointer;
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      border-radius:999px;
      background:linear-gradient(to right,#e5e7eb,#f9fafb,#e5e7eb);
      box-shadow:0 0 18px rgba(248,250,252,0.85);
      pointer-events:none;
    }

    /* --- Volume control --- */
    .volume-wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:0.75rem;
      min-width:0;
    }
    .volume-knob{
      width:36px;
      height:36px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(circle at 30% 18%, rgba(255,255,255,0.26), transparent 55%),
        radial-gradient(circle at 70% 82%, #020617, #020617);
      box-shadow:
        0 6px 14px rgba(0,0,0,0.7),
        inset 0 2px 4px rgba(255,255,255,0.32);
      cursor:pointer;
      filter:drop-shadow(0 0 3px var(--glow-soft));
      transition:transform 120ms ease, box-shadow 140ms ease, filter 140ms ease;
      flex-shrink:0;
    }
    .volume-knob:hover,
    .volume-knob:focus-visible{
      outline:none;
      filter:drop-shadow(0 0 10px var(--glow-strong));
      transform:translateY(-1px);
    }
    .volume-track{
      flex:1;
      max-width:220px;
    }
    .volume-slider{
      width:100%;
      appearance:none;
      height:6px;
      border-radius:999px;
      background:linear-gradient(to right,
        rgba(148,163,184,0.85),
        rgba(71,85,105,0.9));
      outline:none;
      cursor:pointer;
    }
    .volume-slider::-webkit-slider-thumb{
      appearance:none;
      width:16px;
      height:16px;
      border-radius:50%;
      background:#e5e7eb;
      border:1px solid rgba(148,163,184,0.8);
      box-shadow:
        0 0 8px var(--glow-soft),
        0 2px 4px rgba(0,0,0,0.6);
      margin-top:-5px;
    }
    .volume-slider::-moz-range-thumb{
      width:16px;
      height:16px;
      border-radius:50%;
      background:#e5e7eb;
      border:1px solid rgba(148,163,184,0.8);
      box-shadow:
        0 0 8px var(--glow-soft),
        0 2px 4px rgba(0,0,0,0.6);
    }
    .volume-percent{
      font-size:11px;
      color:#94a3b8;
      min-width:32px;
      text-align:right;
    }

    /* --- Vintage transport buttons --- */
    .transport-btn{
      position:relative;
      border-radius:999px;
      width:46px;
      height:46px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(148,163,184,0.7);
      background:
        radial-gradient(circle at 30% 18%, rgba(255,255,255,0.26), transparent 55%),
        radial-gradient(circle at 70% 82%, #020617, #020617);
      box-shadow:
        0 8px 16px rgba(0,0,0,0.7),
        inset 0 2px 4px rgba(255,255,255,0.36);
      transition:
        box-shadow 140ms ease,
        transform 120ms ease,
        border-color 140ms ease,
        background 140ms ease,
        filter 140ms ease;
      color:#e5e7eb;
      cursor:pointer;
      filter:drop-shadow(0 0 3px var(--glow-soft));
    }
    .transport-btn--play{
      width:52px;
      height:52px;
    }
    .transport-btn:hover,
    .transport-btn:focus-visible{
      outline:none;
      transform:translateY(-1px);
      filter:drop-shadow(0 0 10px var(--glow-strong));
    }
    .transport-btn:active{
      transform:translateY(1px) scale(0.97);
      box-shadow:
        0 3px 10px rgba(0,0,0,0.9),
        inset 0 1px 3px rgba(0,0,0,0.7);
    }
    .transport-icon{
      font-size:14px;
      filter:drop-shadow(0 1px 1px rgba(0,0,0,0.9));
    }

    /* --- Mini player overlay --- */

    .mini-player{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:60;
      width:340px;
      max-width:calc(100vw - 32px);
      border-radius:20px;
      border:1px solid rgba(148,163,184,0.75);
      background:
        radial-gradient(circle at 0% 0%, rgba(148,163,184,0.16), transparent 55%),
        linear-gradient(to bottom,#020617,#020617,#020617);
      box-shadow:
        0 18px 36px rgba(0,0,0,0.9),
        0 0 24px rgba(15,23,42,0.9);
      padding:12px 14px 14px;
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
    }

    @media (max-width:640px){
      .mini-player{
        left:12px;
        right:12px;
        bottom:12px;
        width:auto;
      }
    }

    .mini-player-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }
    .mini-player-title{
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mini-player-close{
      border:none;
      background:transparent;
      color:#94a3b8;
      cursor:pointer;
      padding:2px 4px;
      border-radius:999px;
      font-size:13px;
    }
    .mini-player-close:hover{
      color:#e5e7eb;
      background:rgba(15,23,42,0.8);
    }

    .mini-vu-wrap{
      display:flex;
      gap:10px;
      margin-bottom:10px;
    }
    .mini-vu{
      flex:1;
      position:relative;
      height:70px;
      border-radius:12px;
      background:
        linear-gradient(to bottom,#020617,#020617 35%,#020617 100%);
      box-shadow:
        inset 0 0 10px rgba(15,23,42,0.95),
        0 0 12px rgba(15,23,42,0.9);
      overflow:hidden;
    }
    .mini-vu-glow{
      position:absolute;
      inset:6px 6px 10px 6px;
      border-radius:10px;
      background:
        radial-gradient(circle at 50% 110%, rgba(56,189,248,0.85), transparent 65%),
        radial-gradient(circle at 50% -40%, rgba(148,163,184,0.8), transparent 70%);
      opacity:0.2;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .mini-vu-scale{
      position:absolute;
      inset:10px 10px 16px 10px;
      border-radius:8px;
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:inset 0 0 6px rgba(15,23,42,0.95);
    }
    .mini-vu-needle{
      position:absolute;
      bottom:12px;
      left:50%;
      width:2px;
      height:46px;
      background:linear-gradient(to top,#f9fafb,#cbd5f5);
      border-radius:99px;
      transform-origin:bottom center;
      box-shadow:
        0 0 4px rgba(248,250,252,0.9),
        0 -6px 6px rgba(15,23,42,0.85);
    }
    .mini-vu-pivot{
      position:absolute;
      bottom:10px;
      left:50%;
      width:10px;
      height:10px;
      border-radius:999px;
      transform:translateX(-50%);
      background:radial-gradient(circle, #f9fafb, #9ca3af);
      box-shadow:0 0 4px rgba(15,23,42,0.9);
    }

    .mini-progress-rail{
      width:100%;
      height:6px;
      border-radius:999px;
      background:radial-gradient(circle at 50% 150%, rgba(15,23,42,0.9), #020617);
      box-shadow:
        inset 0 0 4px rgba(15,23,42,0.9),
        0 0 10px rgba(15,23,42,0.7);
      overflow:hidden;
      margin-bottom:4px;
    }
    .mini-progress-fill{
      height:100%;
      border-radius:999px;
      background:linear-gradient(to right,#e5e7eb,#f9fafb,#e5e7eb);
      box-shadow:0 0 12px rgba(248,250,252,0.85);
    }
    .mini-times{
      display:flex;
      justify-content:space-between;
      font-size:10px;
      color:#94a3b8;
      margin-bottom:6px;
    }

    .mini-controls-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .mini-transport{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .mini-btn{
      width:30px;
      height:30px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(circle at 30% 18%, rgba(255,255,255,0.22), transparent 55%),
        radial-gradient(circle at 70% 82%, #020617, #020617);
      box-shadow:
        0 4px 10px rgba(0,0,0,0.7),
        inset 0 1px 3px rgba(255,255,255,0.3);
      color:#e5e7eb;
      cursor:pointer;
      font-size:11px;
    }
    .mini-btn-play{
      width:34px;
      height:34px;
    }
    .mini-btn:active{
      transform:translateY(1px) scale(0.97);
      box-shadow:
        0 2px 6px rgba(0,0,0,0.9),
        inset 0 1px 2px rgba(0,0,0,0.7);
    }

    .mini-theme-chips{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini-theme-chip{
      border-radius:999px;
      padding:2px 8px;
      font-size:9px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      border:1px solid rgba(148,163,184,0.7);
      cursor:pointer;
      opacity:0.8;
    }
    .mini-theme-chip.active{
      opacity:1;
      box-shadow:0 0 10px rgba(34,211,238,0.6);
    }

    .mini-popout-hint{
      font-size:10px;
      color:#64748b;
      text-align:right;
      margin-top:4px;
    }
  </style>
</head>
<body>
  <!-- Main nav -->
  <nav class="site-nav" aria-label="Main">
    <a href="/">Home</a>
    <a href="photography.html">Photography</a>
    <a href="music.html" aria-current="page">Music</a>
    <a href="/#contact">Contact</a>
  </nav>

  <div class="wrap">
    <header class="music-header">
      <h1>Original Audio Works</h1>
      <p>Instrumental tracks written &amp; produced by Chris Chattom.</p>
    </header>

    <div id="root"></div>
  </div>

  <!-- React app -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // -------- Track data ----------
    const TRACKS = [
      { id: '01', name: 'The Copycat',             file: 'The_Copycat.mp3' },
      { id: '02', name: 'Moving Forward',          file: 'Moving_Forward.mp3' },
      { id: '03', name: 'Fleetwood National',      file: 'Fleetwood_National.mp3' },
      { id: '04', name: 'Ashes and Aurora',        file: 'Ashes_and_Aurora.mp3' },
      { id: '05', name: 'Sugartrain Voyage',       file: 'Sugartrain_Voyage.mp3' },
      { id: '06', name: 'Car Crash in Cardiff',    file: 'Car_Crash_in_Cardiff.mp3' },
      { id: '07', name: 'Dune Audio',              file: 'Dune_Audio.mp3' },
      { id: '08', name: 'Slow Roast',              file: 'Slow_Roast.mp3' },
      { id: '09', name: 'Bayou Moon',              file: 'Bayou_Moon.mp3' },
      { id: '10', name: 'Lonely Carbon Lifeforms', file: 'Lonely_Carbon_Lifeforms.mp3' },
      { id: '11', name: 'The Magical Third',       file: 'The_Magical_Third.mp3' },
      { id: '12', name: 'Up and Down',             file: 'Up_and_Down.mp3' },
      { id: '13', name: 'Arcadia Drive',           file: 'Arcadia_Drive.mp3' },
      { id: '14', name: 'Ocean Post',              file: 'Ocean_Post.mp3' },
      { id: '15', name: 'Covert Company',          file: 'Covert_Company.mp3' },
      { id: '16', name: 'Too Many Lights',         file: 'Too_Many_Lights.mp3' },
      { id: '17', name: 'American Sword',          file: 'American_Sword.mp3' },
      { id: '18', name: 'Go Driving Fast',         file: 'Go_Driving_Fast.mp3' },
    ];
    const AUDIO_BASE = "assets/";

    // -------- Themes ----------
    const THEMES = {
      "nite life": {
        id: "nite life",
        label: "NITE LIFE",
        bg: "from-slate-800/90 to-slate-950/90",
        border: "border-slate-600",
        text: "text-slate-100",
        textSub: "text-slate-300",
        accent: "text-cyan-400",
        accentHex: "#22d3ee",
        glowSoft: "rgba(34, 211, 238, 0.12)",
        glowStrong: "rgba(34, 211, 238, 0.55)",
      },
      "day break": {
        id: "day break",
        label: "DAY BREAK",
        bg: "from-orange-100/90 to-amber-200/90",
        border: "border-orange-400",
        text: "text-slate-900",
        textSub: "text-orange-900",
        accent: "text-orange-600",
        accentHex: "#fb923c",
        glowSoft: "rgba(251, 146, 60, 0.12)",
        glowStrong: "rgba(251, 146, 60, 0.55)",
      },
      fantasy: {
        id: "fantasy",
        label: "FANTASY",
        bg: "from-purple-800/90 to-fuchsia-950/90",
        border: "border-purple-500",
        text: "text-purple-50",
        textSub: "text-purple-200",
        accent: "text-fuchsia-400",
        accentHex: "#e879f9",
        glowSoft: "rgba(232, 121, 249, 0.12)",
        glowStrong: "rgba(232, 121, 249, 0.55)",
      },
    };

    function formatTime(sec){
      if (!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec/60);
      const s = Math.floor(sec%60);
      return m + ":" + (s < 10 ? "0"+s : s);
    }

    // Web Audio gain + analyser engine.
    function useGainEngine(audioElement, volume, isMuted, isPlaying) {
      const ctxRef = React.useRef(null);
      const sourceRef = React.useRef(null);
      const gainRef = React.useRef(null);
      const analyserRef = React.useRef(null);
      const [hasGain, setHasGain] = React.useState(false);
      const [audioLevel, setAudioLevel] = React.useState(0);

      // Wire the graph once
      React.useEffect(() => {
        if (!audioElement) return;
        if (ctxRef.current) return;

        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;

        try {
          const ctx = new AudioCtx();
          const source = ctx.createMediaElementSource(audioElement);
          const gain = ctx.createGain();
          const analyser = ctx.createAnalyser();

          analyser.fftSize = 256;
          gain.gain.value = isMuted ? 0 : volume;

          source.connect(gain);
          gain.connect(analyser);
          analyser.connect(ctx.destination);

          ctxRef.current = ctx;
          sourceRef.current = source;
          gainRef.current = gain;
          analyserRef.current = analyser;
          setHasGain(true);
        } catch (err) {
          console.warn("Web Audio gain wiring failed:", err);
        }

        return () => {
          if (sourceRef.current) sourceRef.current.disconnect();
          if (analyserRef.current) analyserRef.current.disconnect();
          if (gainRef.current) gainRef.current.disconnect();
          if (ctxRef.current && ctxRef.current.state !== "closed") {
            ctxRef.current.close();
          }
          ctxRef.current = null;
          sourceRef.current = null;
          gainRef.current = null;
          analyserRef.current = null;
        };
      }, [audioElement]);

      // React to volume / mute / play state
      React.useEffect(() => {
        const ctx = ctxRef.current;
        const gain = gainRef.current;
        if (!ctx || !gain) return;

        gain.gain.value = isMuted ? 0 : volume;

        if (isPlaying && ctx.state === "suspended") {
          ctx.resume().catch(() => {});
        }
      }, [volume, isMuted, isPlaying]);

      // Drive audioLevel from analyser
      React.useEffect(() => {
        const analyser = analyserRef.current;
        if (!analyser) return;

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        let rafId;

        const tick = () => {
          analyser.getByteTimeDomainData(dataArray);
          let sum = 0;
          for (let i = 0; i < bufferLength; i++) {
            const v = (dataArray[i] - 128) / 128;
            sum += v * v;
          }
          const rms = Math.sqrt(sum / bufferLength);
          const scaled = Math.max(0, Math.min(1, rms * 5));
          setAudioLevel(scaled);
          rafId = requestAnimationFrame(tick);
        };

        tick();

        return () => {
          if (rafId) cancelAnimationFrame(rafId);
        };
      }, [hasGain]);

      return { hasWebGain: hasGain, audioLevel };
    }

    function ThemeChips({ active, onChange }){
      return (
        <div className="flex flex-wrap justify-center gap-3 mb-6">
          {Object.entries(THEMES).map(([id,t]) => {
            const selected = id === active;
            const base = "px-4 py-1 rounded-full text-xs tracking-[0.16em] font-semibold uppercase border transition-all shadow-sm";
            let bg;
            if (id === "nite life") bg = "bg-slate-900/90 text-cyan-100 border-slate-600";
            if (id === "day break") bg = "bg-amber-200 text-orange-900 border-orange-500";
            if (id === "fantasy") bg = "bg-purple-900/80 text-purple-100 border-purple-500";
            return (
              <button
                key={id}
                type="button"
                onClick={() => onChange(id)}
                className={base + " " + bg + " " + (selected ? "ring-2 ring-offset-2 ring-offset-black" : "opacity-80 hover:opacity-100")}
              >
                {t.label}
              </button>
            );
          })}
        </div>
      );
    }

    function TubeDeck({ trackName, currentTime, duration, theme, level, onSeekClick }){
      const t = THEMES[theme];

      const time = currentTime || 0;
      const tubes = [0, 1, 2, 3, 4].map((_, i) => {
        const phase = i * 0.35;
        const wobble = Math.sin(time * 4 + phase) * 0.18;
        const raw = level + wobble;
        const boosted = 0.12 + (raw - 0.12) * 1.8;
        return Math.max(0.05, Math.min(1.0, boosted));
      });

      const glow = t.accentHex + "dd";
      const progressPercent = duration ? Math.min(100, (currentTime / duration) * 100) : 0;

      return (
        <div className={[
          "w-full max-w-3xl mx-auto rounded-3xl border px-6 py-5 mb-3",
          "bg-gradient-to-b", t.bg, t.border, "shadow-2xl"
        ].join(" ")}>
          <div className="tube-window mb-5">
            {tubes.map((lvl, i) => {
              const coreScale = 0.35 + lvl * 0.9;
              const edgeBlur = 6 + lvl * 28;
              const coreBlur = 16 + lvl * 40;
              const coreOpacity = Math.max(0.4, Math.min(1, 0.65 + lvl * 0.45));

              return (
                <div key={i} className="flex flex-col items-center">
                  <div className="tube-shell">
                    <div
                      className="tube-glass"
                      style={{
                        boxShadow: `
                          inset 0 0 8px rgba(148,163,184,0.55),
                          0 0 ${edgeBlur}px ${glow}
                        `,
                      }}
                    >
                      <div className="tube-electrodes" />
                      <div
                        className="tube-core"
                        style={{
                          transform: `scaleY(${coreScale})`,
                          boxShadow: `0 0 ${coreBlur}px ${glow}`,
                          opacity: coreOpacity,
                        }}
                      />
                      <div className="tube-filament" />
                    </div>
                  </div>
                  <div className="tube-socket">
                    <div className="tube-socket-top" />
                    <div className="tube-socket-post" />
                  </div>
                </div>
              );
            })}
          </div>

          <div className="text-center mb-4">
            <div className={t.text + " text-lg font-semibold"}>
              {trackName || "Select a track from the playlist"}
            </div>
          </div>

          <div className="mt-2">
            <div className="flex items-center justify-between text-[11px] text-slate-400 mb-1 px-0.5">
              <span>{formatTime(currentTime)}</span>
              <span>{formatTime(duration)}</span>
            </div>
            <div className="progress-rail" onClick={onSeekClick}>
              <div
                className="progress-fill"
                style={{ width: progressPercent + "%" }}
              />
            </div>
          </div>
        </div>
      );
    }

    function VintageControls({
      onPlay,
      onPause,
      onStop,
      onSkipBack,
      onSkipForward,
      onRewind,
      onFastForward,
      isPlaying,
    }){
      return (
        <div className="flex items-center justify-center gap-3 sm:gap-4">
          <button
            aria-label="Previous track"
            type="button"
            onClick={onSkipBack}
            className="transport-btn"
          >
            <span className="transport-icon text-xs">‚èÆ</span>
          </button>

          <button
            aria-label="Rewind"
            type="button"
            onClick={onRewind}
            className="transport-btn"
          >
            <span className="transport-icon text-xs">‚è™</span>
          </button>

          <button
            aria-label="Play"
            type="button"
            onClick={onPlay}
            className={
              "transport-btn transport-btn--play" +
              (isPlaying ? " ring-2 ring-offset-2 ring-offset-black ring-cyan-300/70" : "")
            }
          >
            <span className="transport-icon text-sm">‚ñ∂</span>
          </button>

          <button
            aria-label="Pause"
            type="button"
            onClick={onPause}
            className="transport-btn"
          >
            <span className="transport-icon text-sm">‚è∏</span>
          </button>

          <button
            aria-label="Stop"
            type="button"
            onClick={onStop}
            className="transport-btn"
          >
            <span className="transport-icon text-xs">‚ñ†</span>
          </button>

          <button
            aria-label="Fast forward"
            type="button"
            onClick={onFastForward}
            className="transport-btn"
          >
            <span className="transport-icon text-xs">‚è©</span>
          </button>

          <button
            aria-label="Next track"
            type="button"
            onClick={onSkipForward}
            className="transport-btn"
          >
            <span className="transport-icon text-xs">‚è≠</span>
          </button>
        </div>
      );
    }

    function Playlist({ tracks, currentIndex, onSelect, theme }){
      const t = THEMES[theme];
      return (
        <div className={[
          "w-full max-w-3xl mx-auto rounded-3xl border p-5 sm:p-6 shadow-2xl",
          "bg-gradient-to-b", t.bg, t.border
        ].join(" ")}>
          <div className="mb-2">
            <div className="text-[11px] tracking-[0.26em] text-slate-400 uppercase mb-1">
              PLAYLIST
            </div>
            <div className="text-[11px] text-slate-500">
              {tracks.length} Tracks
            </div>
          </div>

          <div className="mt-3 space-y-2 max-h-[480px] overflow-y-auto pr-1">
            {tracks.map((trk, idx) => {
              const active = idx === currentIndex;
              return (
                <button
                  key={trk.id}
                  type="button"
                  onClick={() => onSelect(idx)}
                  className={[
                    "w-full flex items-center justify-between rounded-xl px-3 py-3 text-left border transition-all",
                    active
                      ? "bg-cyan-700/50 border-cyan-400/80 shadow-[0_0_18px_rgba(34,211,238,0.35)]"
                      : "bg-slate-950/40 border-slate-700/70 hover:border-slate-500/70"
                  ].join(" ")}
                >
                  <div className="flex items-center gap-3 min-w-0">
                    <div className="w-5 text-xs text-slate-500">
                      {String(idx+1).padStart(2,"0")}
                    </div>
                    <div className="flex flex-col min-w-0">
                      <span className="text-sm text-slate-100 truncate">
                        {trk.name}
                      </span>
                      <span className="text-[11px] text-cyan-300/80">
                        Track {idx+1}
                      </span>
                    </div>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    // Mini Player component
    function MiniPlayer({
      trackName,
      currentTime,
      duration,
      theme,
      level,
      isPlaying,
      onPlay,
      onPause,
      onSkipBack,
      onSkipForward,
      onThemeChange,
      onClose,
    }){
      const t = THEMES[theme];

      // Normalize level 0‚Äì1 for needle rotation
      const base = Math.max(0, Math.min(1, (level - 0.1) / 0.9));
      const leftLevel = Math.max(0, Math.min(1, base * 1.05));
      const rightLevel = Math.max(0, Math.min(1, base * 0.95));

      const angleMin = -18;
      const angleMax = 18;
      const leftAngle = angleMin + (angleMax - angleMin) * leftLevel;
      const rightAngle = angleMin + (angleMax - angleMin) * rightLevel;

      const glowOpacity = 0.18 + base * 0.65;
      const progressPercent = duration ? Math.min(100, (currentTime / duration) * 100) : 0;

      return (
        <div className="mini-player">
          <div className="mini-player-header">
            <div className="mini-player-title">
              {trackName || "Original Audio Works"}
            </div>
            <button
              type="button"
              className="mini-player-close"
              onClick={onClose}
              aria-label="Close mini player"
            >
              √ó
            </button>
          </div>

          <div className="mini-vu-wrap">
            {[leftAngle, rightAngle].map((angle, idx) => (
              <div key={idx} className="mini-vu">
                <div
                  className="mini-vu-glow"
                  style={{
                    opacity: glowOpacity,
                    background: `
                      radial-gradient(circle at 50% 110%, rgba(56,189,248,${0.7 + base * 0.6}), transparent 65%),
                      radial-gradient(circle at 50% -40%, rgba(148,163,184,${0.8 + base * 0.4}), transparent 70%)
                    `
                  }}
                />
                <div className="mini-vu-scale" />
                <div
                  className="mini-vu-needle"
                  style={{ transform: `translateX(-50%) rotate(${angle}deg)` }}
                />
                <div className="mini-vu-pivot" />
              </div>
            ))}
          </div>

          <div className="mini-progress-rail">
            <div
              className="mini-progress-fill"
              style={{ width: progressPercent + "%" }}
            />
          </div>
          <div className="mini-times">
            <span>{formatTime(currentTime)}</span>
            <span>{formatTime(duration)}</span>
          </div>

          <div className="mini-controls-row">
            <div className="mini-transport">
              <button
                type="button"
                className="mini-btn"
                aria-label="Previous track"
                onClick={onSkipBack}
              >
                ‚èÆ
              </button>
              <button
                type="button"
                className="mini-btn"
                aria-label="Previous section"
                onClick={() => { /* small nudge back feels too fiddly here, so skip */ }}
              >
                ‚Äπ
              </button>
              <button
                type="button"
                className={"mini-btn mini-btn-play"}
                aria-label={isPlaying ? "Pause" : "Play"}
                onClick={isPlaying ? onPause : onPlay}
              >
                {isPlaying ? "‚è∏" : "‚ñ∂"}
              </button>
              <button
                type="button"
                className="mini-btn"
                aria-label="Next track"
                onClick={onSkipForward}
              >
                ‚è≠
              </button>
            </div>

            <div className="mini-theme-chips">
              {Object.entries(THEMES).map(([id, themeDef]) => (
                <button
                  key={id}
                  type="button"
                  className={
                    "mini-theme-chip" +
                    (id === theme ? " active" : "")
                  }
                  onClick={() => onThemeChange(id)}
                >
                  {themeDef.label}
                </button>
              ))}
            </div>
          </div>

          <div className="mini-popout-hint">
            Mini player ‚Äî keeps playing while you browse
          </div>
        </div>
      );
    }

    function MusicApp(){
      const [currentIndex,setCurrentIndex] = useState(0);
      const [theme,setTheme] = useState("nite life");
      const [isPlaying,setIsPlaying] = useState(false);
      const [currentTime,setCurrentTime] = useState(0);
      const [duration,setDuration] = useState(0);
      const [volume,setVolume] = useState(0.9);
      const [isMuted,setIsMuted] = useState(false);
      const [showMini,setShowMini] = useState(false);

      const audioRef = useRef(null);
      const activeTrack = TRACKS[currentIndex];

      const { hasWebGain, audioLevel } = useGainEngine(
        audioRef.current,
        volume,
        isMuted,
        isPlaying
      );

      // Visual tube intensity derived from playback state
      let level;
      if (!isPlaying || isMuted) {
        level = 0.12;
      } else if (hasWebGain) {
        const base = 0.15 + audioLevel * (0.9 + volume * 0.6);
        level = Math.max(0.05, Math.min(1.0, base));
      } else {
        const t = currentTime || 0;
        const baseVal = 0.35 + 0.25 * Math.sin(t * 2.2);
        const wobble = 0.15 * Math.sin(t * 7.1 + 1.4);
        const noiseSeed = (Math.sin(t * 12.7) + 1) / 2;
        const noise = (noiseSeed - 0.5) * 0.25;
        const amp = 0.25 + volume * 0.75;
        const raw = 0.18 + amp * (baseVal + wobble + noise);
        level = Math.max(0.05, Math.min(1.0, raw));
      }

      // time / metadata listeners + auto-advance on track end
      useEffect(() => {
        const audio = audioRef.current;
        if (!audio) return;

        const onTime = () => {
          setCurrentTime(audio.currentTime || 0);
        };

        const onMeta = () => {
          setDuration(audio.duration || 0);
        };

        const onEnded = () => {
          setCurrentTime(0);
          setCurrentIndex(prev => (prev + 1) % TRACKS.length);
          setIsPlaying(true);
        };

        audio.addEventListener("timeupdate", onTime);
        audio.addEventListener("loadedmetadata", onMeta);
        audio.addEventListener("ended", onEnded);

        return () => {
          audio.removeEventListener("timeupdate", onTime);
          audio.removeEventListener("loadedmetadata", onMeta);
          audio.removeEventListener("ended", onEnded);
        };
      }, []);

      // Load track whenever index changes
      useEffect(() => {
        const audio = audioRef.current;
        if (!audio || !activeTrack) return;

        audio.src = AUDIO_BASE + activeTrack.file;
        audio.load();
        audio.currentTime = 0;
        setCurrentTime(0);

        if (isPlaying){
          audio.play().catch(() => setIsPlaying(false));
        }
      }, [currentIndex, activeTrack]);

      // Volume / mute -> audio element
      useEffect(() => {
        const audio = audioRef.current;
        if (!audio) return;

        if (!hasWebGain) {
          audio.volume = isMuted ? 0 : volume;
        }
        audio.muted = isMuted;
      }, [volume, isMuted, hasWebGain]);

      const handleNudge = (deltaSeconds) => {
        const audio = audioRef.current;
        if (!audio || !duration) return;
        const next = Math.max(0, Math.min(duration, (audio.currentTime || 0) + deltaSeconds));
        audio.currentTime = next;
        setCurrentTime(next);
      };

      const handlePlay = () => {
        const audio = audioRef.current;
        if (!audio) return;
        audio.play()
          .then(() => setIsPlaying(true))
          .catch(() => {});
      };

      const handlePause = () => {
        const audio = audioRef.current;
        if (!audio) return;

        if (isPlaying) {
          audio.pause();
          const t = audio.currentTime || 0;
          setCurrentTime(t);
          setIsPlaying(false);
        } else {
          audio.play()
            .then(() => {
              setIsPlaying(true);
            })
            .catch(() => {});
        }
      };

      const handleStop = () => {
        const audio = audioRef.current;
        if (!audio) return;
        audio.pause();
        audio.currentTime = 0;
        setCurrentTime(0);
        setIsPlaying(false);
      };

      const handleSkipBack = () => {
        setCurrentIndex(prev => (prev - 1 + TRACKS.length) % TRACKS.length);
      };

      const handleSkipForward = () => {
        setCurrentIndex(prev => (prev + 1) % TRACKS.length);
      };

      const handleRewind = () => handleNudge(-3);
      const handleFastForward = () => handleNudge(3);

      const handleSelectTrack = (idx) => {
        setCurrentIndex(idx);
        setIsPlaying(true);
      };

      const handleSeekClick = (e) => {
        const audio = audioRef.current;
        if (!audio || !duration) return;
        const rect = e.currentTarget.getBoundingClientRect();
        const ratio = (e.clientX - rect.left) / rect.width;
        const clamped = Math.max(0, Math.min(1, ratio));
        const newTime = clamped * duration;
        audio.currentTime = newTime;
        setCurrentTime(newTime);
      };

      const handleVolumeChange = (e) => {
        const value = parseFloat(e.target.value);
        if (Number.isNaN(value)) return;
        setVolume(value);
      };

      const handleToggleMute = () => {
        setIsMuted(prev => !prev);
      };

      const themeDef = THEMES[theme];
      const volumePercent = Math.round(volume * 100);

      return (
        <div
          className="mt-6 flex flex-col items-center"
          style={{
            '--glow-soft': themeDef.glowSoft,
            '--glow-strong': themeDef.glowStrong,
          }}
        >
          <ThemeChips active={theme} onChange={setTheme} />

          <TubeDeck
            trackName={activeTrack ? activeTrack.name : ""}
            currentTime={currentTime}
            duration={duration}
            theme={theme}
            level={level}
            onSeekClick={handleSeekClick}
          />

          {/* Mini player trigger button */}
          <div className="w-full max-w-3xl mx-auto flex items-center justify-end mb-4">
            <button
              type="button"
              onClick={() => setShowMini(true)}
              className="px-3 py-1.5 rounded-full text-[11px] tracking-[0.18em] uppercase border border-cyan-400/70 text-cyan-200 bg-slate-900/80 shadow-[0_0_18px_rgba(34,211,238,0.45)] hover:bg-slate-800/80 transition-colors"
            >
              ‚§¢ Mini Player
            </button>
          </div>

          {/* Controls row */}
          <div className="w-full max-w-3xl flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <div className="flex justify-center">
              <VintageControls
                onSkipBack={handleSkipBack}
                onRewind={handleRewind}
                onPlay={handlePlay}
                onPause={handlePause}
                onStop={handleStop}
                onFastForward={handleFastForward}
                onSkipForward={handleSkipForward}
                isPlaying={isPlaying}
              />
            </div>

            <div className="volume-wrap md:justify-start">
              <button
                type="button"
                className="volume-knob"
                aria-label={isMuted ? "Unmute" : "Mute"}
                onClick={handleToggleMute}
              >
                <span className="text-xs">
                  {isMuted ? "üîá" : "üîä"}
                </span>
              </button>
              <div className="volume-track">
                <input
                  type="range"
                  min="0"
                  max="1"
                  step="0.01"
                  value={volume}
                  onChange={handleVolumeChange}
                  className="volume-slider"
                />
              </div>
              <div className="volume-percent">
                {isMuted ? "0%" : volumePercent + "%"}
              </div>
            </div>
          </div>

          <Playlist
            tracks={TRACKS}
            currentIndex={currentIndex}
            onSelect={handleSelectTrack}
            theme={theme}
          />

          {showMini && (
            <MiniPlayer
              trackName={activeTrack ? activeTrack.name : ""}
              currentTime={currentTime}
              duration={duration}
              theme={theme}
              level={level}
              isPlaying={isPlaying}
              onPlay={handlePlay}
              onPause={handlePause}
              onSkipBack={handleSkipBack}
              onSkipForward={handleSkipForward}
              onThemeChange={setTheme}
              onClose={() => setShowMini(false)}
            />
          )}

          <audio ref={audioRef} className="hidden">
            Your browser does not support the audio element.
          </audio>
        </div>
      );
    }

    const rootEl = document.getElementById("root");
    if (rootEl){
      const root = ReactDOM.createRoot(rootEl);
      root.render(<MusicApp />);
    }
  </script>
</body>
</html>
